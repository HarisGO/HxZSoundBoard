<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>SoundBoard</title>
<link rel="stylesheet" href="styles.css">
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>🔊</text></svg>">
<meta name="theme-color" content="#0d0d0f">
</head>
<body>
<header>
  <h1 id="headline">SoundBoard</h1>
  <div id="controls">
    <select id="lang"></select>
    <button id="theme">🌓</button>
    <button id="refresh">↻ <span class="lbl">Refresh</span></button>
    <label><input id="overlap" type="checkbox"> <span class="lbl">Play together</span></label>
  </div>
</header>

<section id="wall"></section>

<div id="addCard" class="card">
  <div class="title">Post your sound</div>
  <div class="lang">Upload MP3 / WAV / OGG – stored locally</div>
  <button id="pickBtn">Choose file</button>
  <input id="fileIn" type="file" accept="audio/*">
</div>

<div id="transport">
  <button id="playBtn">▶</button>
  <span id="time">0:00 / 0:00</span>
  <input id="progress" type="range" value="0" step="0.1" min="0" max="100">
  <input id="volume" type="range" value="70" min="0" max="100" title="Volume">
</div>

<script type="module">
/* 1. I18N */
const i18n={
  en:{headline:"SoundBoard",refresh:"Refresh",together:"Play together",post:"Post your sound",stored:"stored locally",choose:"Choose file",time:"Time"},
  ur:{headline:"ساؤنڈ بورڈ",refresh:"ریفریش",together:"ایک ساتھ چلائیں",post:"اپنا آواز ڈالیں",stored:"براؤزر میں محفوظ",choose:"فائل چنیں",time:"وقت"},
  ar:{headline:"لوحة الصوت",refresh:"تحديث",together:"شغّل معًا",post:"أضف صوتك",stored:"يُخزّن بالمتصفح",choose:"اختر ملفًا",time:"الوقت"},
  ps:{headline:"غږونو بورډ",refresh:"تازه کول",together:"یوځای پلی کړئ",post:"خپل غږ ورکړئ",stored:"په براوزر کې خوندي",choose:"فایل وټاکئ",time:"وخت"},
  fa:{headline:"تابلو صدا",refresh:"تازه‌سازی",together:"باهم پخش شود",post:"صدا خود را اضافه کنید",stored:"در مرورگر ذخیره می‌شود",choose:"انتخاب فایل",time:"زمان"},
  zh:{headline:"音效板",refresh:"刷新",together:"同时播放",post:"上传你的声音",stored:"仅保存在浏览器",choose:"选择文件",time:"时间"}
};
let lang='en';
function T(k){return i18n[lang][k]||i18n.en[k]}
function setLang(l){
  lang=l; localStorage.setItem('lang',l);
  document.querySelector('#headline').textContent=T('headline');
  document.querySelector('#refresh .lbl').textContent=T('refresh');
  document.querySelector('label .lbl').textContent=T('together');
  document.querySelector('#addCard .title').textContent=T('post');
  document.querySelector('#addCard .lang').textContent=T('stored');
  document.querySelector('#pickBtn').textContent=T('choose');
}

/* 2. STATE */
let audioCtx=null;
const wall=document.getElementById('wall');
const playBtn=document.getElementById('playBtn');
const prog=document.getElementById('progress');
const vol=document.getElementById('volume');
const overlap=document.getElementById('overlap');
const timeLbl=document.getElementById('time');

/* 3. INDEXEDDB */
let db;
import{openDB}from'https://unpkg.com/idb?module';
(async()=>{db=await openDB('SB',1,{upgrade(d){d.createObjectStore('ups',{keyPath:'name'});}});})();

/* 4. UTILS */
function fmt(t){const m=Math.floor(t/60),s=Math.floor(t%60);return m+':'+(s<10?'0':'')+s;}
function stopOthers(){if(!overlap.checked&&audioCtx){audioCtx.pause();audioCtx.currentTime=0;}}
async function addCard(name,url){
  const card=document.createElement('div'); card.className='card'; card.dataset.name=name; card.dataset.src=url;
  card.innerHTML=`<audio src="${url}"></audio><div class="title">${name}</div><div class="lang">${T('stored')}</div>`;
  const audio=card.querySelector('audio');
  card.onclick=()=>{stopOthers(); audio.play();};
  audio.onplay=()=>{wall.querySelectorAll('.card').forEach(c=>c.classList.remove('playing')); card.classList.add('playing'); audioCtx=audio; syncTransport(audio);};
  audio.onpause=audio.onended=()=>card.classList.remove('playing');
  wall.appendChild(card);
}
function syncTransport(a){
  const upd=()=>{if(a.paused)return; prog.value=100*(a.currentTime/a.duration)||0; timeLbl.textContent=fmt(a.currentTime)+' / '+fmt(a.duration||0); requestAnimationFrame(upd);};
  a.onloadedmetadata=()=>timeLbl.textContent='0:00 / '+fmt(a.duration);
  upd();
}
playBtn.onclick=()=>{if(!audioCtx)return; if(audioCtx.paused){audioCtx.play(); playBtn.textContent='❚❚';}else{audioCtx.pause(); playBtn.textContent='▶';}};
prog.oninput=()=>{if(audioCtx)audioCtx.currentTime=prog.value/100*audioCtx.duration;};
vol.oninput=()=>{wall.querySelectorAll('audio').forEach(a=>a.volume=vol.value/100);};

/* 5. SCAN SOURCES */
const GD_ID='1d2EnaQQ3S2bwUN4JlMJydlifmJE5kZ6A'; // your folder
async function scanGDrive(){
  const url=`https://www.googleapis.com/drive/v3/files?q='${GD_ID}'+and+trashed=false&fields=files(name,webContentLink)&key=AIzaSyC1grvJpJLKxL5ebH2xhpBBODfu5M0I7ao`;
  const j=await fetch(url).then(r=>r.json()).catch(()=>({files:[]}));
  return j.files.filter(f=>/\.(mp3|wav|ogg|m4a)$/i.test(f.name)).map(f=>({name:f.name,url:f.webContentLink}));
}
async function refresh(){
  wall.innerHTML='';
  // gdrive
  const gd=await scanGDrive();
  gd.forEach(s=>addCard(s.name,s.url));
  // uploads
  const ups=await db.getAll('ups');
  for(const u of ups) addCard(u.name,URL.createObjectURL(u.blob));
}
document.getElementById('refresh').onclick=refresh;

/* 6. UPLOAD */
document.getElementById('pickBtn').onclick=()=>document.getElementById('fileIn').click();
document.getElementById('fileIn').onchange=async(e)=>{
  const f=e.target.files[0]; if(!f) return;
  await db.put('ups',{name:f.name,blob:f});
  addCard(f.name,URL.createObjectURL(f));
  e.target.value='';
};

/* 7. LANG & THEME */
const sel=document.getElementById('lang'); Object.keys(i18n).forEach(l=>sel.add(new Option(l.toUpperCase(),l)));
sel.value=localStorage.getItem('lang')||'en'; setLang(sel.value);
sel.onchange=(e)=>setLang(e.target.value);
document.getElementById('theme').onclick=()=>document.body.classList.toggle('light');

/* 8. KEYBOARD */
window.onkeydown=e=>{
  if(!audioCtx) return;
  if(e.code==='Space'){e.preventDefault();playBtn.click();}
  else if(e.code==='ArrowLeft') audioCtx.currentTime=Math.max(0,audioCtx.currentTime-5);
  else if(e.code==='ArrowRight')audioCtx.currentTime=Math.min(audioCtx.duration,audioCtx.currentTime+5);
  else if(e.code==='ArrowUp')   vol.value=Math.min(100,parseInt(vol.value)+5);
  else if(e.code==='ArrowDown') vol.value=Math.max(0,parseInt(vol.value)-5);
  vol.oninput();
};

/* 9. INIT */
refresh();
</script>
</body>
</html>